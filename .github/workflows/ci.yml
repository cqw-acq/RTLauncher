name: CI - Dioxus build (official)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Install dioxus-cli (official CLI)
      run: |
        # Try installing the stable published CLI first; fallback to git if needed
        cargo install --locked dioxus-cli || cargo install --git https://github.com/DioxusLabs/dioxus dioxus-cli

    - name: Build with official Dioxus CLI
      run: dx build --release

    - name: Package artifact (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path artifacts
        # compress .exe and any runtime files in target\release
        $files = Get-ChildItem -Path target\release -File -Recurse | Where-Object { $_.Extension -eq '.exe' -or $_.Extension -eq '.dll' -or $_.Extension -eq '.pdb' -or $_.Extension -eq '.manifest' }
        if ($files) {
          Compress-Archive -Path ( $files | ForEach-Object { $_.FullName } ) -DestinationPath artifacts/build-windows.zip -Force
        } else {
          # fallback: zip everything under target\release
          Compress-Archive -Path 'target\release\*' -DestinationPath 'artifacts/build-windows.zip' -Force
        }

    - name: Package artifact (macOS / Linux)
      if: runner.os != 'Windows'
      run: |
        mkdir -p artifacts
        # Prefer zip, fallback to tar.gz
        if command -v zip >/dev/null 2>&1; then
          zip -r artifacts/build-${{ matrix.os }}.zip target/release || true
        else
          tar -czf artifacts/build-${{ matrix.os }}.tar.gz -C target release || true
        fi

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.os }}
        path: artifacts/*
        retention-days: 7

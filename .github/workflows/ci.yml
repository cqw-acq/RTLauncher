name: CI - Dioxus build (fast)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    env:
      # Put cargo and rustup inside the workspace so they can be cached
      CARGO_HOME: ${{ github.workspace }}/.cargo
      RUSTUP_HOME: ${{ github.workspace }}/.rustup

    steps:
    - uses: actions/checkout@v4

    - name: Restore cargo and target cache
      uses: actions/cache@v4
      id: cargo-cache
      with:
        path: |
          .cargo/registry
          .cargo/git
          .cargo/bin
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true

    - name: Install cargo-binstall (Linux / macOS)
      if: runner.os != 'Windows'
      run: |
        if ! command -v cargo-binstall >/dev/null 2>&1; then
          cargo install --locked cargo-binstall || true
        else
          echo "cargo-binstall already installed"
        fi

    - name: Install cargo-binstall (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if (Get-Command cargo-binstall -ErrorAction SilentlyContinue) {
          Write-Host 'cargo-binstall already installed'
        } else {
          try {
            cargo install --locked cargo-binstall
          } catch {
            Write-Host 'cargo-binstall install failed (continuing)'
          }
        }

    - name: Install dioxus-cli (Linux / macOS)
      if: runner.os != 'Windows'
      run: |
        if command -v dx >/dev/null 2>&1; then
          echo "dioxus-cli (dx) already installed"
        else
          if command -v cargo-binstall >/dev/null 2>&1; then
            cargo binstall dioxus-cli || cargo install --locked dioxus-cli || true
          else
            cargo install --locked dioxus-cli || true
          fi
        fi

    - name: Install dioxus-cli (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if (Get-Command dx -ErrorAction SilentlyContinue) {
          Write-Host 'dioxus-cli (dx) already installed'
        } else {
          if (Get-Command cargo-binstall -ErrorAction SilentlyContinue) {
            try {
              cargo binstall dioxus-cli
            } catch {
              Write-Host 'cargo binstall failed, falling back to cargo install'
              try { cargo install --locked dioxus-cli } catch { Write-Host 'cargo install failed (continuing)' }
            }
          } else {
            try { cargo install --locked dioxus-cli } catch { Write-Host 'cargo install failed (continuing)' }
          }
        }

    - name: Build with official Dioxus CLI
      run: dx build --release

    - name: Package artifact (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path artifacts
        $files = Get-ChildItem -Path target\release -File -Recurse | Where-Object { $_.Extension -eq '.exe' -or $_.Extension -eq '.dll' -or $_.Extension -eq '.pdb' -or $_.Extension -eq '.manifest' }
        if ($files) {
          Compress-Archive -Path ( $files | ForEach-Object { $_.FullName } ) -DestinationPath artifacts/build-windows.zip -Force
        } else {
          Compress-Archive -Path 'target\release\*' -DestinationPath 'artifacts/build-windows.zip' -Force
        }

    - name: Package artifact (macOS / Linux)
      if: runner.os != 'Windows'
      run: |
        mkdir -p artifacts
        if command -v zip >/dev/null 2>&1; then
          zip -r artifacts/build-${{ matrix.os }}.zip target/release || true
        else
          tar -czf artifacts/build-${{ matrix.os }}.tar.gz -C target release || true
        fi

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-${{ matrix.os }}
        path: artifacts/*
        retention-days: 7
